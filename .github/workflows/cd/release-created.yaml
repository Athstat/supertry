# This workflow runs when a github release has been created
# It will first build, test and lint the app 
# then it will trigger a build on render and deploy to production
# a slack notification with the release name, version (tag) and release notes is
# sent so people are aware of the pushes made

name: Release Created Workflow
on:
    release:
        types: [created]
        branches: [main]

jobs:
    cd-checks:
        name: Lint, Test & Build
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
            uses: actions/checkout@v4

        - name: Setup Node JS Environment
            uses: actions/setup-node@v4
            with:
            node-version: 18
            cache: 'pnpm'

        - name: Install pnpm
            run: npm install -g pnpm

        - name: Install dependencies
            run: pnpm install

        - name: Lint
            run: pnpm lint

        - name: Run tests
            run: pnpm test

        - name: Build
            run: pnpm build
    
    deploy-production:
        name: Deploy to Production
        needs: cd-checks
        runs-on: ubuntu-latest

        steps:
            - name: Trigger Render production deploy
            env:
                RENDER_PROD_DEPLOY_HOOK: ${{ secrets.RENDER_PROD_DEPLOY_HOOK }}
            run: |
                echo "Triggering Render production deploy"
                curl -X POST "$RENDER_PROD_DEPLOY_HOOK"


    slack-notify:
        name: Slack Release Notification
        needs: deploy-production
        runs-on: ubuntu-latest

        steps:
        - name: Send Slack notification
            env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_CI_WEBHOOK_URL }}
            run: |
            RELEASE_NAME="${{ github.event.release.name }}"
            TAG="${{ github.event.release.tag_name }}"
            RELEASE_NOTES="${{ github.event.release.body }}"
            REPO="${{ github.repository }}"
            RELEASE_URL="${{ github.event.release.html_url }}"

            payload=$(cat <<EOF
            {
                "text": ":rocket: *Production Release Deployed*\n\n*Repo:* ${REPO}\n*Release:* ${RELEASE_NAME}\n*Version:* ${TAG}\n\n*Release Notes:*\n${RELEASE_NOTES}\n\n<${RELEASE_URL}|View Release>"
            }
            EOF
            )

            curl -X POST -H "Content-type: application/json" \
                --data "$payload" \
                $SLACK_WEBHOOK_URL