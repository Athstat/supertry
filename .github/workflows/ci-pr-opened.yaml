# This is a github actions workflow that runs when
# a new pull request is created, or when updates to 
# a pull request have been made

# It also sends a notification to the assigned 
# reviewer to make sure they don't miss it

name: Pull Request Opened Workflow
run-name: CI Checks for PR ${{ github.event.pull_request.number }}
on: 
    pull_request:
        types: [opened, reopened, assigned, synchronize, review_requested]
        branches: [main]


# Runs Pull Request checks, lint, test and build checks
jobs:
    ci-checks:
        name: Lint, Test & Build
        if: |
          github.event.action == 'opened' ||
          github.event.action == 'reopened' ||
          github.event.action == 'synchronize'
        runs-on: ubuntu-latest
        strategy:
          matrix:
            node-version: [20]

        # Dummy Environment Variables for building app
        env:
          VITE_API_BASE_URL: http:localhost:8080
          VITE_AMPLITUDE_API_KEY: dummy-amplitude-key
          VITE_APP_ENV: qa
          VITE_AF_ONELINK_BASE_URL: dummy-one-link-api-key
          VITE_FEATURE_LEAGUE_GROUP_ID: dummy-featured-league-id


        steps:
          - uses: actions/checkout@v4
          
          - name: Install pnpm
            uses: pnpm/action-setup@v4

          - name: Use Node.js ${{ matrix.node-version }}
            uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node-version }}
              cache: "pnpm"

          - name: Install dependencies
            run: pnpm install

          - name: Lint
            run: pnpm lint

          - name: Run tests
            run: pnpm test

          - name: Build
            run: pnpm build
    
    # Job to Notify assigned reviewer on slack
    notify-reviewer:
      name: Notify Assigned Reviewer on Slack
      if: github.event.action == 'assigned' || github.event.action == 'review_requested'
      runs-on: ubuntu-latest

      steps:
        - name: Send Slack Notification
          uses: slackapi/slack-github-action@v1.24.0
          with:
            payload: |
              {
                "text": ":technologist: *Pull Request Review Requested*",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": ":technologist: *Pull Request Review Requested*\n\n*Repo:* ${{ github.repository }}\n*Title:* ${{ github.event.pull_request.title }}\n*Author:* ${{ github.event.pull_request.user.login }}\n*Assignee:* ${{ (github.event.assignee && github.event.assignee.login) || (github.event.pull_request && github.event.pull_request.assignee && github.event.pull_request.assignee.login) || (github.event.pull_request && github.event.pull_request.requested_reviewers && github.event.pull_request.requested_reviewers[0] && github.event.pull_request.requested_reviewers[0].login) || 'unknown' }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View PR"
                        },
                        "url": "${{ github.event.pull_request.html_url }}"
                      }
                    ]
                  }
                ]
              }
          env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_CI_WEBHOOK_URL }}
            SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK