# This is a github actions workflow that runs when a pull
# request to the main branch is closed, and builds, tests
# and deploys to QA/UAT environment

name: Pull Request Closed Workflow
on:
    pull_request:
        types: [closed]
        branches: [main]


# Continuosly Integrate the PR to QA Environment
jobs:
    ci-checks:
        name: Lint, Test & Build
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        timeout-minutes: 30
        strategy:
          matrix:
            node-version: [20]

        # Dummy Environment Variables for building app
        env:
          VITE_API_BASE_URL: http:localhost:8080
          VITE_AMPLITUDE_API_KEY: dummy-amplitude-key
          VITE_APP_ENV: qa
          VITE_AF_ONELINK_BASE_URL: dummy-one-link-api-key
          VITE_FEATURE_LEAGUE_GROUP_ID: dummy-featured-league-id



        steps:
          - uses: actions/checkout@v4
          
          - name: Install pnpm
            uses: pnpm/action-setup@v4
            with:
              version: 10

          - name: Use Node.js ${{ matrix.node-version }}
            uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node-version }}
              cache: "pnpm"

          - name: Lint
            run: pnpm lint

          - name: Run tests
            run: pnpm test

          - name: Build
            run: pnpm build
    
    
    deploy-to-qa:
        name: Deploy to QA
        needs: ci-checks
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Trigger Render Deploy Hook
              env: 
                RENDER_QA_DEPLOY_HOOK: ${{ secrets.RENDER_QA_DEPLOY_HOOK }}
              run: |
                if [ -z "$RENDER_QA_DEPLOY_HOOK" ]; then
                  echo "Error: RENDER_QA_DEPLOY_HOOK secret not configured"
                  exit 1
                fi
                echo "PR merged â€” triggering QA deploy on Render"
                curl -X POST "$RENDER_QA_DEPLOY_HOOK" \
                  --fail \
                  --retry 3 \
                  --retry-delay 5

    notify-qa-deployment:
        name: Notify QA Deployment
        needs: deploy-to-qa
        runs-on: ubuntu-latest
        if: always()
        timeout-minutes: 5

        steps:
        - name: Send Slack notification
          uses: slackapi/slack-github-action@v1.24.0
          with:
            payload: |
              {
                "text": "QA Deployment Triggered",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": ":rocket: *QA Deployment Triggered*\n\n*Repo:* ${{ github.repository }}\n*PR:* #${{ github.event.pull_request.number }}\n*Title:* ${{ github.event.pull_request.title }}\n*Author:* ${{ github.event.pull_request.user.login }}\n*Status:* ${{ needs.deploy-to-qa.result }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View PR"
                        },
                        "url": "${{ github.event.pull_request.html_url }}"
                      }
                    ]
                  }
                ]
              }
          env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_CI_WEBHOOK_URL }}
            SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK