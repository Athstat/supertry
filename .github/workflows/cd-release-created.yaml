# This workflow runs when a github release has been created
# It will first build, test and lint the app 
# then it will trigger a build on render and deploy to production
# a slack notification with the release name, version (tag) and release notes is
# sent so people are aware of the pushes made

name: Release Created Workflow
on:
    release:
        types: [created]

jobs:
    cd-checks:
        name: Lint, Test & Build
        runs-on: ubuntu-latest
        timeout-minutes: 30
        strategy:
          matrix:
            node-version: [20]
        
        # Dummy Environment Variables for building app
        env:
          VITE_API_BASE_URL: http:localhost:8080
          VITE_AMPLITUDE_API_KEY: dummy-amplitude-key
          VITE_APP_ENV: prod
          VITE_AF_ONELINK_BASE_URL: dummy-one-link-api-key
          VITE_FEATURE_LEAGUE_GROUP_ID: dummy-featured-league-id


        steps:
          - uses: actions/checkout@v4
          
          - name: Install pnpm
            uses: pnpm/action-setup@v4
            with:
              version: 10

          - name: Use Node.js ${{ matrix.node-version }}
            uses: actions/setup-node@v4
            with:
              node-version: ${{ matrix.node-version }}
              cache: "pnpm"

          - name: Install dependencies
            run: pnpm install

          - name: Lint
            run: pnpm lint

          - name: Run tests
            run: pnpm test

          - name: Build
            run: pnpm build
    
    
    deploy-production:
        name: Deploy to Production
        needs: cd-checks
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Trigger Render production deploy
              env:
                RENDER_PROD_DEPLOY_HOOK: ${{ secrets.RENDER_PROD_DEPLOY_HOOK }}
              run: |
                if [ -z "$RENDER_PROD_DEPLOY_HOOK" ]; then
                  echo "Error: RENDER_PROD_DEPLOY_HOOK secret not configured"
                  exit 1
                fi
                echo "Triggering Render production deploy"
                curl -X POST "$RENDER_PROD_DEPLOY_HOOK" \
                  --fail \
                  --retry 3 \
                  --retry-delay 5

    slack-notify-release:
        name: Slack Release Notification
        needs: [cd-checks, deploy-production]
        runs-on: ubuntu-latest
        timeout-minutes: 5
        if: always()

        steps:
        - name: Determine Status
          id: status
          run: |
            if [ "${{ needs.cd-checks.result }}" != "success" ] || [ "${{ needs.deploy-production.result }}" != "success" ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "color=danger" >> $GITHUB_OUTPUT
              echo "emoji=âŒ" >> $GITHUB_OUTPUT
            else
              echo "status=succeeded" >> $GITHUB_OUTPUT
              echo "color=good" >> $GITHUB_OUTPUT
              echo "emoji=ðŸš€" >> $GITHUB_OUTPUT
            fi

        - name: Send Slack notification
          uses: slackapi/slack-github-action@v1.24.0
          with:
            payload: |
              {
                "text": "${{ steps.status.outputs.emoji }} Production Release Deployed",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "${{ steps.status.outputs.emoji }} *Production Release Deployed*\n\n*Repo:* ${{ github.repository }}\n*Release:* ${{ github.event.release.name }}\n*Version:* ${{ github.event.release.tag_name }}\n*Status:* ${{ steps.status.outputs.status }}"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Release Notes:*\n${{ github.event.release.body }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Release"
                        },
                        "url": "${{ github.event.release.html_url }}"
                      }
                    ]
                  }
                ]
              }
          env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_CI_WEBHOOK_URL }}
            SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK